{% load static %}
<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <!-- Primary Meta Tags -->
      <title>WitSwap</title>
      <meta name="title" content="Meta Tags — Preview, Edit and Generate">
      <meta name="description" content="">
      <!-- Open Graph / Facebook -->
      <meta property="og:type" content="website">
      <meta property="og:url" content="https://witswap.io/">
      <meta property="og:title" content=" e">
      <meta property="og:description" content=" ">
      <meta property="og:image" content=" ">
      <!-- Twitter -->
      <meta property="twitter:card" content="summary_large_image">
      <meta property="twitter:url" content="https://witswap.io/">
      <meta property="twitter:title" content=" ">
      <meta property="twitter:description" content=" ">
      <meta property="twitter:image" content=" ">
      <link rel="canonical" href="">
      <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
      <link href="{% static 'css/style.css' %}" rel="stylesheet">
   </head>
   <body>
      <div id="home" class="w-100 h-100">
         <div class="img-back-degrade"></div>
      </div>
      <header>
         <!-- navbar -->
         <nav class="navbar navbar-expand-md navbar-dark py-3">
            <div class="container ">
               <div class="row mx-0 px-0 w-100 mb-5 d-flex align-items-center">
                   <a class="navbar-brand text-wit" href="#"><img src="/static/img/logow.png" style="height: 80px"></a>
                   <ul class="d-flex align-items-center list-unstyled ml-md-auto mr-md-0 mx-auto mb-0">
                     <li class="mr-2">
                        <a href="https://medium.com/search?q=witswap" target="_blank" class="btn wit-btn wit-btn-primary wit-border-fx">How To Use <strong>WitSWAP </strong></a>
                     </li>
                     <li class="mr-2">
                        <a href="https://twitter.com/witswap?s=21" target="_blank" class="btn wit-btn wit-btn-icon-only wit-btn-pill wit-btn-primary"><i class="fab fa-twitter"></i></a>
                     </li>
                     <li class="mr-2">
                        <a href="https://t.me/witswap" target="_blank" class="btn wit-btn wit-btn-icon-only wit-btn-pill wit-btn-primary"><i class="fas fa-paper-plane"></i></a>
                     </li>
                     <li class="mr-2">
                        <a href="https://medium.com/search?q=witswap" target="_blank" class="btn wit-btn wit-btn-icon-only wit-btn-pill wit-btn-primary"><i class="fab fa-medium-m"></i></a>
                     </li>
                  </ul>
               </div>
            </div>
         </nav>
      </header>
      <!--   -->
      <main role="main" class="flex-shrink-0">
         <div class="container">
            <div class="row mx-0 px-0">
               <div class="col-md-8 offset-md-2 shadow-inset rounded">
                  <div class="row row-cols-1 row-cols-md-3">
                     <div class="col">
                        <div class="card wit-card">
                           <div class="card-body text-center">
                              <p class="card-text"> Total WITs Swapped to Date</p>
                              <h5 class="card-title wit-card-title total-swapped">{{ total_swapped }}</h5>
                           </div>
                        </div>
                     </div>
                     <!-- 2-->
                     <div class="col">
                        <div class="card wit-card">
                           <div class="card-body text-center">
                              <p class="card-text">Total eWIT in Circulation</p>
                              <h5 class="card-title wit-card-title total-circulation">0</h5>
                           </div>
                        </div>
                     </div>
                     <!--3-->
                     <div class="col">
                        <div class="card wit-card">
                           <div class="card-body text-center">
                              <p class="card-text">Current Price of eWIT</p>
                              <h5 class="card-title wit-card-title">- ETH</h5>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            {% if not address %}
            <h5 class="col-12 py-4 text-center">Welcome to <strong>WitSwap</strong>. This is a new project, so please use it with caution.</h5>
            <form method="post">
               {% csrf_token %}
               <input type="hidden" name="direction" class="direction">
               <div class="form-row mx-0 px-0 d-flex justify-content-center pb-3">
                  <div class="col-auto mr-md-3 mr-0">
                     <button class="select-ewit btn wit-btn wit-btn-primary btn-wit" type="button">GET e<span class="white_span">WIT</span></button>
                  </div>
                  <div class="col-auto">
                     <button class="select-wit btn wit-btn wit-btn-primary btn-wit btn-wit_green" type="button">GET <span class="white_span">WIT</span></button>
                  </div>
               </div>
               <div class="form-row mx-0 px-0 d-flex justify-content-center pb-4 amount-row">
                  <div class="col-md-8 mx-auto">
                     <div class="input-group">
                        <input name="convert_amount" type="text" class="form-control convert-amount" aria-label="Convert Amount" placeholder="Number of tokens you want to swap">
                        <div class="input-group-append">
                           <span class="input-group-text btn-wit token-selected btn-wit-input-1">e<span>Wit</span></span>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="form-row mx-0 px-0 d-flex justify-content-center ">
                  <div class="col-md-8 mx-auto">
                     <div class="input-group mb-3">
                        <input name="send_swapped_funds_to" type="text" class="form-control destination-address" placeholder="WIT destination address"
                           aria-label="ETH Destination Address" aria-describedby="button-addon2">
                        <div class="input-group-append wallet-button" style="display:none">
                           <button class="btn btn-outline-secondary btn-wit-input-group" type="button" id="button-addon2">Wallet</button>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="form-row mx-0 px-0 d-flex justify-content-center" style="display: none!important;">
                  <div class="col-6 col-md-3">
                     <label for="exampleInputEmail1">Conversion Rate</label>
                     <input type="Rate" class="form-control wit-input " id="Rate" aria-describedby="Rate">
                     <small id="Rate" class="form-text text-muted">Wit rate 0,40.</small>
                  </div>
                  <div class="col-6 col-md-3">
                     <label for="exampleInputEmail1">You Will Receive</label>
                     <input type="Receive" class="form-control wit-input" id="Receive" aria-describedby="Receive">
                     <small id="Receive" class="form-text text-muted">Excepteur sint occaecat cupidatat.</small>
                  </div>
               </div>
            </form>
            <div class="row mx-0 d-flex justify-content-center pt-5 button-convert">
               <a href="javascript:doConversion();" class="btn-get-wit btn wit-btn wit-btn-primary wit-border-fx">Swap eWIT to WIT</a>
            </div>
            {% if fee_percentage > 0 %}
            <div class="row mx-0 d-flex justify-content-center pt-2 div-total-fees">
               <p>A <span class="total-fees">{{ fee_percentage }}</span>% fee is deducted when swapping from WIT to eWIT to pay for minting costs & project maintenance.</p>
            </div>
            {% endif %}
            {% else %}
            <div class="row mx-0 pt-2 next-steps pt-4">
                <div class="col-md-8 offset-md-2" style="background: rgba(38,41,45,.45);border-radius: 8px;">
                  <div class="my-2">Here is what you need to do next:</div>
                  <div class="mb-2">Transfer your tokens to: {{ address }}</div>
                  <div class="row mx-0">
                    <div>
                        Current balance is
                            <span class="current-balance">0</span>
                            <span class="ml-3 spinner">
                            <span class="fas fa-sync-alt spinner-border spinner-border-sm"></span>
                            </span>
                    </div>
                    <div class="ml-auto">
                        <a href="javascript:accept();" class="btn-get-wit btn wit-btn wit-btn-primary wit-border-fx">Confirm</a>
                    </div>
                   </div>
                   <div class="mb-2">You can do this in several transactions.</div>
                   <div class="mb2">Once you are finished, press the confirm button to indicate that you are done.</div>
                   <div class="pb-2">If you don't confirm your request, your funds will be returned to you in 24 hours.</div>
                </div>
            </div>
            {% endif %}

            <!--last transactions-->
            <div class="row mx-0 px-0 py-5">
               <div class="col-md-8 offset-md-2 shadow-inset rounded bg-lastT pb-2 table-responsive">
                  <p class="pt-3 small">Last Transactions</p>
                  <table class="table table-hover table-dark">
                     <thead>
                        <tr>
                           <th scope="col">Total</th>
                           <th scope="col">Date</th>
                           <th scope="col">Swap Transaction</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for transaction in transactions  %}
                        <tr>
                           <td>{{ transaction.input }}</td>
                           <td>{{ transaction.date }}</td>
                           <td><a target="_blank" href="{{ transaction.transaction_link }}">{{ transaction.transaction_hash }}</a></td>
                        </tr>
                        {% endfor %}
                     </tbody>
                  </table>
               </div>
            </div>
         </div>
      </main>
      <footer class="footer mt-auto py-3">
         <div class="container">
            <span class="text-muted">© 2021 WitSwap.</span>
         </div>
      </footer>
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
      <script>window.jQuery || document.write('<script src="../assets/js/vendor/jquery.slim.min.js"><\/script>')</script>
      <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
   </body>
</html>

<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/web3.min.js' %}"></script>
<script src="{% static 'js/ewit_token.js' %}"></script>
<script src="{% static 'js/sweetalert.js' %}"></script>

<script type="text/javascript">

    const web3 = new Web3(window.ethereum);
    const tokenInstance = new web3.eth.Contract(JSON.parse(ewit_abi), '{{ token_address }}');

    function showError(message) {
        Swal.fire({
            icon: 'error',
              title: 'Oops...',
              html: message
            });
    }

    function showSuccess(message) {
        Swal.fire({
            icon: 'success',
              title: 'Sent...',
              text: message
            });
    }

    {% if error %}
        showError('{{ error }}');
    {% endif %}

    $(".select-ewit").click(function() {
        $('.wallet-button').show();
        $('.direction').val('WitToeWIT')
        $('.select-wit').removeClass('btn-wit_green');
        $('.select-ewit').addClass('btn-wit_green');
        $('.amount-row').attr('style','display:none !important');
        $('.destination-address').attr('placeholder', 'ETH destination address');
        $('.btn-get-wit').html('Swap WIT to eWIT');
    });

    $(".select-wit").click(function() {
        $('.wallet-button').hide();
        $('.direction').val('eWitToWIT');
        $('.select-wit').addClass('btn-wit_green');
        $('.select-ewit').removeClass('btn-wit_green');
        $('.amount-row').attr('style','display:flex !important');
        $('.destination-address').attr('placeholder', 'WIT destination address');
        $('.btn-get-wit').html('Swap eWIT to WIT');
    });

    async function doConversion() {
        $('.spinner').remove();

        const destinationAddress = $('.destination-address').val();

        if (destinationAddress.length < 42) {
            showError('Complete a valid address');
            return;
        }

        if ($('.direction').val() == 'WitToeWIT') {
            $('.btn-get-wit').html($('.btn-get-wit').html() + '<span class="ml-1 spinner"><span class="fas fa-sync-alt spinner-border spinner-border-sm"></span></span>');
            $('form').submit();
        } else {
            const convertAmount = parseInt($('.convert-amount').val());

            if (isNaN(convertAmount)) {
                showError('Complete a valid amount');
                return;
            }

            if (convertAmount < 10000) {
                showError('The minimum to convert is 10,000 tokens');
                return;
            }

            const balance = await getTokensBalance();

            if (balance < convertAmount) {
                showError("You don't have enough tokens");
                return;
            }

            const convertAmountDecimals = "0x" + (convertAmount * 1e9).toString(16);

            $('.btn-get-wit').html($('.btn-get-wit').html() + '<span class="ml-1 spinner"><span class="fas fa-sync-alt spinner-border spinner-border-sm"></span></span>');

            tokenInstance.methods.swap($('.destination-address').val(), convertAmountDecimals).send({from:wallet})
                .on('transactionHash', function(transactionHash){
                    showSuccess('Please wait for the transaction to be mined');
                    waitForReceiptCallback(transactionHash);
                });
        }
    }

    function waitForReceiptCallback(transactionHash) {
        web3.eth.getTransactionReceipt(transactionHash, function(err, receipt) {
            if (err) {
                console.log(err);
                showError('An error occurred, please try again: ' + JSON.stringify(err));
            }
            else {
                if (receipt == null) {
                    setTimeout(function(){ waitForReceiptCallback(transactionHash); }, 1000);
                }
                else {
                    $('.spinner').remove();
                    showSuccess('Your swap request was sent correctly');
                }
            }
        });
    }

    async function getTokensBalance() {
        const data = await promisify(cb => tokenInstance.methods.balanceOf(wallet).call(cb));
        return data / 1e9;
    }

    const promisify = (inner) =>
        new Promise((resolve, reject) =>
            inner((err, res) => {
                if (err) {
                    reject(err);
                } else {
                    resolve(res);
                }
            })
    );

    async function getTotalSupply() {
        try {
            const data = await promisify(cb => tokenInstance.methods.totalSupply().call(cb));
            const totalTokens = data / 1e9;
            $('.total-circulation').html(totalTokens);
        } catch(e) {
            setTimeout(function(){ getTotalSupply(); }, 2000);
            document.write(e)
        }
    }

    /*async function getTotalFees() {
        const data = await promisify(cb => tokenInstance.methods.feePercentage().call(cb));
        const fees = data / 10;
        $('.total-fees').html(fees);
        if (data == "0") {
            $('.div-total-fees').remove();
        }
    }*/

    $('#button-addon2').click(function() {
        $('.destination-address').val(wallet);
    });

    let wallet;

    async function getAccounts() {
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.enable();
            const accounts = await ethereum.request({ method: 'eth_accounts' });
            if (accounts.length == 0) {
                console.log('Locked');
            } else {
                wallet = accounts[0];
                getTotalSupply();
                getInitialAmount();
            }
        }
    }

    getAccounts();

    async function getInitialAmount() {
        try {
            const totalTokens = await getTokensBalance();
            if (totalTokens > 0) {
                $('.convert-amount').val(totalTokens);
            }
        } catch(e) {
            setTimeout(function(){ getInitialAmount(); }, 2000);
            document.write(e)
        }
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            let c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1)
            {
                c_start = c_start + c_name.length + 1;
                let c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start,c_end));
            }
        }
        return "";
    }

    {% if address %}

        function getBalance() {
            try {
              $.ajax({ url: '/balance/{{ swap_uuid }}/'})
                .done(function(data) {
                    if (data.balance > 0 && data.unconfirmed_balance > 0) {
                        $('.current-balance').html(data.balance + ' WIT (confirmed) and ' + data.unconfirmed_balance + ' WIT (waiting for confirmation)');
                    } else if (data.unconfirmed_balance > 0) {
                        $('.current-balance').html(data.unconfirmed_balance + ' WIT (waiting for confirmation, please wait)');
                    } else if (data.balance > 0) {
                        $('.current-balance').html(data.balance + ' WIT');
                    } else {
                        $('.current-balance').html('0 WIT');
                    }
                    if (data.balance) {
                        $('.current-balance').html(data.balance);
                    }
                    setTimeout(function(){ getBalance(); }, 5000);
              });
            }
            catch(err) {
                setTimeout(function(){ getBalance(); }, 5000);
            }
        }

        getBalance();

        function accept() {
            $.ajax({
              headers: { "X-CSRFToken": getCookie("csrftoken") },
              url: '/accept/{{ swap_uuid }}/',
              cache: false,
              contentType: false,
              processData: false,
              method: 'POST',
            })
            .done(function(data) {
                if (data && data.updated) {
                    $('.next-steps').html('<div class="col-md-8 offset-md-2"><div class="my-2">Your swap request was generated successfully</div></div>');
                    showSuccess('Your swap request was generated successfully');
                }
                else {
                    showError('An error occurred, try again later');
                }
          })
          .catch(function(error) {
              if (error.status == 400) {
                  showError('You can\'t confirm until you send at least 10,000 WIT and they are confirmed');
              } else {
                  showError('An error occurred, please try again');
              }
          });
        }

    {% endif %}


</script>
